name: .NET CI/CD with Code Coverage

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  build-and-test:
    runs-on: windows-latest

    steps:
      # 1. Checkout del código
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Instalar .NET 5
      - name: Setup .NET 5.0
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '5.0.x'

      # 3. Restaurar dependencias (esto instalará coverlet.msbuild)
      - name: Restore dependencies
        run: dotnet restore TrabajoTarjeta.sln

      # 4. Compilar en modo Release
      - name: Build
        run: dotnet build TrabajoTarjeta.sln --no-restore -c Release

      # 5. Ejecutar tests con cobertura usando MSBuild
      - name: Run tests with coverage
        run: |
          dotnet test "TrabajoTarjeta.Tests/TrabajoTarjeta.Tests.csproj" `
            --no-build `
            -c Release `
            --logger trx `
            --results-directory TestResults `
            /p:CollectCoverage=true `
            /p:CoverletOutput=TestResults/ `
            /p:CoverletOutputFormat=cobertura `
            /p:Include="[TrabajoTarjeta]*" `
            /p:Exclude="[TrabajoTarjeta.Tests]*" `
            /p:ExcludeByFile="**/obj/**"

      # 6. Verificar archivos generados
      - name: Check generated files
        run: |
          Write-Host "=== Listando archivos en TestResults ==="
          if (Test-Path "TestResults") {
            Get-ChildItem -Recurse -Path "TestResults" -Force
          } else {
            Write-Host "No existe el directorio TestResults"
          }
          Write-Host "=== Buscando archivos de cobertura ==="
          Get-ChildItem -Recurse -Path . -Filter "*.cobertura.xml" | Select-Object FullName

      # 7. Instalar ReportGenerator (SOLUCIÓN AL PROBLEMA DEL TOOL)
      - name: Install ReportGenerator
        run: |
          dotnet tool install --global dotnet-reportgenerator-globaltool --version 4.8.12
          # Agregar al PATH manualmente
          echo "C:\Users\runneradmin\.dotnet\tools" | Out-File -FilePath $env:GITHUB_PATH -Append

      # 8. Generar reporte
      - name: Generate coverage report
        run: |
          # Buscar archivo de cobertura
          $coverageFiles = Get-ChildItem -Recurse -Path . -Filter "*.cobertura.xml"
          if ($coverageFiles.Count -eq 0) {
            Write-Host "ERROR: No se encontraron archivos de cobertura"
            Write-Host "Buscando cualquier archivo XML:"
            Get-ChildItem -Recurse -Path . -Filter "*.xml" | Select-Object Name, Directory
            exit 1
          }
          Write-Host "Archivos de cobertura encontrados:"
          $coverageFiles | ForEach-Object { Write-Host "  - $($_.FullName)" }
          $coverageFile = $coverageFiles[0].FullName
          Write-Host "Usando archivo: $coverageFile"
          reportgenerator -reports:"$coverageFile" -targetdir:"coveragereport" -reporttypes:Cobertura

      # 9. Subir cobertura a Codecov
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: TestResults/coverage.cobertura.xml
          fail_ci_if_error: true
          verbose: true
